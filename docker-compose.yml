services:
  ash-bot:
    #build:
      #context: .
      #dockerfile: Dockerfile
    image: ghcr.io/the-alphabet-cartel/ash-bot:latest
    container_name: ash-bot
    restart: unless-stopped
    networks:
      - ash-network
    ports:
      - 8882:8882  
    environment:
      # Core Discord and Claude settings (using Docker Secrets)
      - BOT_DISCORD_TOKEN=${BOT_DISCORD_TOKEN}
      - GLOBAL_SESSION_TOKEN=${GLOBAL_SESSION_TOKEN}
      - GLOBAL_CLAUDE_API_KEY=${GLOBAL_CLAUDE_API_KEY}

      # Claude Configuration
      - GLOBAL_CLAUDE_MODEL=${GLOBAL_CLAUDE_MODEL}

      # Discord and Channel Configuration
      - BOT_GUILD_ID=${BOT_GUILD_ID}
      - BOT_RESOURCES_CHANNEL_ID=${BOT_RESOURCES_CHANNEL_ID}
      - BOT_CRISIS_RESPONSE_CHANNEL_ID=${BOT_CRISIS_RESPONSE_CHANNEL_ID}
      - BOT_ALLOWED_CHANNELS=${BOT_ALLOWED_CHANNELS}

      # Team Configuration
      - BOT_STAFF_PING_USER=${BOT_STAFF_PING_USER}
      - BOT_CRISIS_RESPONSE_ROLE_ID=${BOT_CRISIS_RESPONSE_ROLE_ID}
      - BOT_RESOURCES_CHANNEL_NAME=${BOT_RESOURCES_CHANNEL_NAME}
      - BOT_CRISIS_RESPONSE_ROLE_NAME=${BOT_CRISIS_RESPONSE_ROLE_NAME}
      - BOT_STAFF_PING_NAME=${BOT_STAFF_PING_NAME}

      # API Server Configuration
      - GLOBAL_BOT_API_HOST=${GLOBAL_BOT_API_HOST:-0.0.0.0}
      - GLOBAL_BOT_API_PORT=${GLOBAL_BOT_API_PORT:-8882}
      - BOT_API_RATE_LIMIT_PER_MINUTE=${BOT_API_RATE_LIMIT_PER_MINUTE:-60}
      - BOT_API_RATE_LIMIT_PER_HOUR=${BOT_API_RATE_LIMIT_PER_HOUR:-1000}
      - GLOBAL_API_ENABLE_CORS=${GLOBAL_API_ENABLE_CORS:-true}
      - GLOBAL_API_ALLOWED_ORIGINS=${GLOBAL_API_ALLOWED_ORIGINS:-*}

      # Learning System Configuration
      - GLOBAL_ENABLE_LEARNING_SYSTEM=${GLOBAL_ENABLE_LEARNING_SYSTEM}
      - BOT_LEARNING_CONFIDENCE_THRESHOLD=${BOT_LEARNING_CONFIDENCE_THRESHOLD}
      - BOT_MAX_LEARNING_ADJUSTMENTS_PER_DAY=${BOT_MAX_LEARNING_ADJUSTMENTS_PER_DAY}

      # NLP Server Configuration
      - GLOBAL_NLP_API_HOST=${GLOBAL_NLP_API_HOST}
      - GLOBAL_NLP_API_PORT=${GLOBAL_NLP_API_PORT:-8881}

      # Bot Behavior Configuration
      - GLOBAL_LOG_LEVEL=${GLOBAL_LOG_LEVEL:-INFO}
      - BOT_MAX_DAILY_CALLS=${BOT_MAX_DAILY_CALLS:-1000}
      - BOT_RATE_LIMIT_PER_USER=${BOT_RATE_LIMIT_PER_USER:-10}

      # Conversation Configuration
      - BOT_CONVERSATION_REQUIRES_MENTION=${BOT_CONVERSATION_REQUIRES_MENTION:-true}
      - BOT_CONVERSATION_TRIGGER_PHRASES=${BOT_CONVERSATION_TRIGGER_PHRASES:-ash,hey ash,ash help,@ash}
      - BOT_CONVERSATION_ALLOW_STARTERS=${BOT_CONVERSATION_ALLOW_STARTERS:-true}
      - BOT_CONVERSATION_SETUP_INSTRUCTIONS=${BOT_CONVERSATION_SETUP_INSTRUCTIONS:-true}
      - BOT_CONVERSATION_LOG_ATTEMPTS=${BOT_CONVERSATION_LOG_ATTEMPTS:-true}
      - BOT_CONVERSATION_TIMEOUT=${BOT_CONVERSATION_TIMEOUT:-300}

      # Performance Monitoring
      - BOT_ENABLE_PERFORMANCE_TRACKING=${BOT_ENABLE_PERFORMANCE_TRACKING:-true}
      - BOT_TRACK_RESPONSE_TIMES=${BOT_TRACK_RESPONSE_TIMES:-true}
      - BOT_TRACK_MEMORY_USAGE=${BOT_TRACK_MEMORY_USAGE:-true}
      - BOT_COLLECT_CRISIS_STATS=${BOT_COLLECT_CRISIS_STATS:-true}
      - BOT_COLLECT_KEYWORD_STATS=${BOT_COLLECT_KEYWORD_STATS:-true}
      - BOT_COLLECT_LEARNING_STATS=${BOT_COLLECT_LEARNING_STATS:-true}
      - BOT_API_RATE_LIMIT_PER_MINUTE=${BOT_API_RATE_LIMIT_PER_MINUTE:-90}
      - BOT_LOGS_RETENTION_DAYS=${BOT_LOGS_RETENTION_DAYS:-30}
    volumes:
      - ./bot/logs:/app/logs
      - ./bot/data:/app/data
      - ./bot/secrets:/run/secrets:ro
    user: "1001:1001"
    depends_on:
      ash-redis:
        condition: service_started
    healthcheck:
      test: ["CMD", "python", "-c", "import discord; print('OK')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  ash-redis:
    image: redis:7-alpine
    container_name: ash-redis
    restart: unless-stopped
    volumes:
      - redis_data:/data
    networks:
      - ash-network

volumes:
  redis_data:

networks:
  ash-network:
    driver: bridge