# ============================================================================
# Ash-Bot v5.0 Docker Compose Configuration
# ============================================================================
# FILE VERSION: v5.0.2
# LAST MODIFIED: 2026-01-04
# Repository: https://github.com/the-alphabet-cartel/ash-bot
# Community: The Alphabet Cartel - https://discord.gg/alphabetcartel
# ============================================================================
#
# USAGE:
#   # Start services (production)
#   docker-compose up -d
#
#   # Start services (development - uses override file automatically)
#   docker-compose up -d
#
#   # Build and start
#   docker-compose up -d --build
#
#   # View logs
#   docker-compose logs -f ash-bot
#
#   # Run tests inside container
#   docker exec ash-bot python -m pytest tests/ -v
#
#   # Run Python script
#   docker exec ash-bot python main.py
#
#   # Stop services
#   docker-compose down
#
# SECRETS:
#   Secrets are stored in ./secrets/ directory:
#   - ./secrets/claude_api_token    - Claude API key
#   - ./secrets/discord_bot_token   - Discord bot token
#   - ./secrets/discord_alert_token - Discord webhook for alerts (optional)
#   - ./secrets/redis_token         - Redis password
#
# REQUIREMENTS:
#   - Docker Engine 24.0+
#   - Docker Compose v5.0.0+
#
# ============================================================================

services:
  # ===========================================================================
  # Ash-Bot Service
  # ===========================================================================
  ash-bot:
    image: ghcr.io/the-alphabet-cartel/ash-bot:latest
    container_name: ash-bot
    build:
      context: .
      dockerfile: Dockerfile
      target: runtime
      args:
        APP_USER: bot
        APP_UID: 1001
        APP_GID: 1001

    # Restart policy
    restart: unless-stopped

    # Network
    networks:
      - ash-network

    # Environment variables
    env_file:
      - .env

    environment:
      - BOT_ENVIRONMENT=production
      - TZ=America/Los_Angeles

    # Port mapping for health checks
    ports:
      - "8080:8080"

    # Volume mounts
    volumes:
      - ./logs:/app/logs

    # Docker Secrets
    secrets:
      - claude_api_token
      - discord_alert_token
      - discord_bot_token

    # Health check - uses HTTP endpoint from health server
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

    # Resource limits (production)
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

    # Labels for organization
    labels:
      - "com.alphabetcartel.service=ash-bot"
      - "com.alphabetcartel.version=5.0.0"
      - "com.alphabetcartel.description=Crisis Detection Discord Bot"

    # Dependencies
    depends_on:
      ash-redis:
        condition: service_healthy

  # ===========================================================================
  # Ash-Redis Cache
  # ===========================================================================
  ash-redis:
    image: redis:7-alpine
    container_name: ash-redis

    # Restart policy
    restart: unless-stopped

    # Network
    networks:
      - ash-network

    # Port mapping (internal only in production, exposed in dev override)
    expose:
      - "6379"

    # Volume mounts
    volumes:
      - redis_data:/data

    # Redis configuration
    command:
      - redis-server
      - --appendonly
      - "yes"
      - --maxmemory
      - 256mb
      - --maxmemory-policy
      - allkeys-lru

    # Health check
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

    # Resource limits
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.25"

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "3"

    # Labels
    labels:
      - "com.alphabetcartel.service=ash-redis"
      - "com.alphabetcartel.description=Redis cache for Ash-Bot"

# =============================================================================
# Volumes
# =============================================================================
volumes:
  redis_data:
    name: ash-redis-data
    driver: local

# =============================================================================
# Secrets
# =============================================================================
secrets:
  claude_api_token:
    file: ./secrets/claude_api_token
  discord_alert_token:
    file: ./secrets/discord_alert_token
  discord_bot_token:
    file: ./secrets/discord_bot_token
  redis_token:
    file: ./secrets/redis_token
  webhook_token:
    file: ./secrets/webhook_token

# =============================================================================
# Networks
# =============================================================================
networks:
  ash-network:
    name: ash-network
    driver: bridge
    external: true
